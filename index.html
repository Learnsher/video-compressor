<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®‰å…¨å½±ç‰‡å£“ç¸®å·¥å…·</title>
    <style>
        /* ä¿æŒåŸæœ¬çš„CSS */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #333;
            margin-bottom: 8px;
            font-size: 28px;
        }
        .security-note {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 12px 16px;
            margin-bottom: 24px;
            border-radius: 4px;
            font-size: 14px;
            color: #2e7d32;
        }
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 24px;
        }
        .upload-area:hover { border-color: #667eea; background: #f8f9ff; }
        .upload-area.dragover { border-color: #667eea; background: #e8ebff; }
        input[type="file"] { display: none; }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        .btn:hover { background: #5568d3; }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .info-box {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            font-family: monospace;
            font-size: 13px;
            line-height: 1.6;
        }
        .info-box h3 {
            margin-bottom: 12px;
            font-size: 16px;
            color: #555;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }
        .options {
            display: grid;
            gap: 16px;
            margin: 24px 0;
        }
        .option-group {
            display: grid;
            grid-template-columns: 150px 1fr;
            align-items: center;
            gap: 12px;
        }
        label {
            font-weight: 500;
            color: #555;
        }
        input[type="number"], input[type="range"], select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            width: 100%;
        }
        .range-container {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .range-container input[type="range"] { flex: 1; }
        .range-value {
            min-width: 40px;
            text-align: center;
            font-weight: 600;
            color: #667eea;
        }
        .prediction {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 12px 16px;
            margin: 16px 0;
            border-radius: 4px;
            font-weight: 500;
        }
        .progress {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin: 16px 0;
            display: none;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s;
            width: 0%;
        }
        .hidden { display: none; }
        .radio-group {
            display: flex;
            gap: 16px;
        }
        .radio-group label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: normal;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”’ å®‰å…¨å½±ç‰‡å£“ç¸®å·¥å…·</h1>
        <div class="security-note">
            âœ… 100% æœ¬åœ°è™•ç†ï¼Œå½±ç‰‡ä¸æœƒä¸Šå‚³åˆ°ä»»ä½•ä¼ºæœå™¨ | âœ… é–‹æºä»£ç¢¼å¯å¯©æŸ¥ | âœ… ç„¡è¿½è¹¤ç„¡å»£å‘Š
        </div>

        <div class="upload-area" id="uploadArea">
            <input type="file" id="fileInput" accept="video/*">
            <p style="font-size: 18px; margin-bottom: 8px;">ğŸ“ é»æ“Šæˆ–æ‹–æ”¾å½±ç‰‡æª”æ¡ˆ</p>
            <p style="color: #888; font-size: 14px;">æ”¯æ´ MP4, MOV, AVI ç­‰æ ¼å¼ï¼ˆå»ºè­° < 500MBï¼‰</p>
        </div>

        <div id="videoInfo" class="info-box hidden">
            <h3>åŸå§‹å½±ç‰‡è³‡è¨Š</h3>
            <div id="infoContent"></div>
        </div>

        <div id="optionsPanel" class="hidden">
            <h3 style="margin-bottom: 16px; color: #333;">å£“ç¸®é¸é …</h3>
            
            <div class="options">
                <div class="option-group">
                    <label>ç·¨ç¢¼å™¨</label>
                    <select id="codec">
                        <option value="libx264">H.264 (ç›¸å®¹æ€§å¥½)</option>
                        <option value="libx265">H.265 (æ›´å°ä½†è¼ƒæ…¢)</option>
                    </select>
                </div>

                <div class="option-group">
                    <label>å£“ç¸®æ¨¡å¼</label>
                    <div class="radio-group">
                        <label><input type="radio" name="mode" value="crf" checked> CRF å“è³ª</label>
                        <label><input type="radio" name="mode" value="bitrate"> å›ºå®šæ¯”ç‰¹ç‡</label>
                        <label><input type="radio" name="mode" value="size"> ç›®æ¨™å¤§å°</label>
                    </div>
                </div>

                <div class="option-group" id="crfOption">
                    <label>CRF å€¼ (18-32)</label>
                    <div class="range-container">
                        <input type="range" id="crf" min="18" max="32" value="23">
                        <span class="range-value" id="crfValue">23</span>
                    </div>
                </div>

                <div class="option-group hidden" id="bitrateOption">
                    <label>å½±ç‰‡æ¯”ç‰¹ç‡ (Mbps)</label>
                    <input type="number" id="bitrate" min="0.5" max="20" step="0.5" value="3">
                </div>

                <div class="option-group hidden" id="sizeOption">
                    <label>ç›®æ¨™å¤§å° (MB)</label>
                    <input type="number" id="targetSize" min="0.5" max="100" step="0.5" value="2">
                </div>

                <div class="option-group">
                    <label>è§£æåº¦</label>
                    <select id="resolution">
                        <option value="original">ä¿æŒåŸå°ºå¯¸</option>
                        <option value="1280:720">720p (1280Ã—720)</option>
                        <option value="960:540">540p (960Ã—540)</option>
                        <option value="640:480">480p (640Ã—480)</option>
                    </select>
                </div>

                <div class="option-group">
                    <label>å¹€ç‡</label>
                    <select id="fps">
                        <option value="original">ä¿æŒåŸå¹€ç‡</option>
                        <option value="30">30 fps</option>
                        <option value="24">24 fps</option>
                    </select>
                </div>

                <div class="option-group">
                    <label>éŸ³è¨Šæ¯”ç‰¹ç‡</label>
                    <select id="audioBitrate">
                        <option value="128k">128 kbps (é«˜)</option>
                        <option value="96k">96 kbps (ä¸­)</option>
                        <option value="64k">64 kbps (ä½)</option>
                    </select>
                </div>
            </div>

            <div id="prediction" class="prediction hidden"></div>

            <div class="progress" id="progress">
                <div class="progress-bar" id="progressBar"></div>
            </div>

            <button class="btn" id="compressBtn">ğŸš€ é–‹å§‹å£“ç¸®</button>
            <button class="btn hidden" id="downloadBtn">ğŸ’¾ ä¸‹è¼‰å£“ç¸®å½±ç‰‡</button>
        </div>
    </div>

    <script type="module">
        import { FFmpeg } from 'https://esm.sh/@ffmpeg/ffmpeg@0.12.10';
        import { fetchFile, toBlobURL } from 'https://esm.sh/@ffmpeg/util@0.12.1';
        
        let ffmpeg = null;
        let videoFile = null;
        let videoInfo = null;
        let compressedBlob = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            ffmpeg = new FFmpeg();
            ffmpeg.on('log', ({ message }) => console.log(message));
            ffmpeg.on('progress', ({ progress }) => {
                const percent = Math.round(progress * 100);
                document.getElementById('progressBar').style.width = percent + '%';
            });

            setupEventListeners();
        });

        function setupEventListeners() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            // é»æ“Šä¸Šå‚³
            uploadArea.addEventListener('click', () => {
                console.log('Upload area clicked');
                fileInput.click();
            });
            
            // æª”æ¡ˆé¸æ“‡
            fileInput.addEventListener('change', (e) => {
                console.log('File selected:', e.target.files[0]);
                handleFile(e.target.files[0]);
            });
            
            // æ‹–æ”¾
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFile(e.dataTransfer.files[0]);
            });

            // æ¨¡å¼åˆ‡æ›
            document.querySelectorAll('input[name="mode"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    document.getElementById('crfOption').classList.toggle('hidden', e.target.value !== 'crf');
                    document.getElementById('bitrateOption').classList.toggle('hidden', e.target.value !== 'bitrate');
                    document.getElementById('sizeOption').classList.toggle('hidden', e.target.value !== 'size');
                    updatePrediction();
                });
            });

            // CRF slider
            document.getElementById('crf').addEventListener('input', (e) => {
                document.getElementById('crfValue').textContent = e.target.value;
                updatePrediction();
            });

            // æ‰€æœ‰é¸é …è®Šæ›´æ™‚æ›´æ–°é æ¸¬
            ['codec', 'bitrate', 'targetSize', 'resolution', 'fps', 'audioBitrate'].forEach(id => {
                document.getElementById(id).addEventListener('change', updatePrediction);
            });

            // å£“ç¸®æŒ‰éˆ•
            document.getElementById('compressBtn').addEventListener('click', compressVideo);
            
            // ä¸‹è¼‰æŒ‰éˆ•
            document.getElementById('downloadBtn').addEventListener('click', downloadVideo);
        }

        async function handleFile(file) {
            if (!file || !file.type.startsWith('video/')) {
                alert('è«‹ä¸Šå‚³å½±ç‰‡æª”æ¡ˆ');
                return;
            }

            videoFile = file;
            
            if (!ffmpeg.loaded) {
                document.getElementById('uploadArea').innerHTML = '<p>â³ è¼‰å…¥å£“ç¸®å¼•æ“ä¸­...ï¼ˆé¦–æ¬¡éœ€ä¸‹è¼‰ç´„31MBï¼Œè«‹ç¨å€™ï¼‰</p>';
                
                try {
                    const baseURL = 'https://unpkg.com/@ffmpeg/core@0.12.6/dist/esm';
                    await ffmpeg.load({
                        coreURL: await toBlobURL(
                            `${baseURL}/ffmpeg-core.js`,
                            'text/javascript'
                        ),
                        wasmURL: await toBlobURL(
                            `${baseURL}/ffmpeg-core.wasm`,
                            'application/wasm'
                        ),
                    });
                    document.getElementById('uploadArea').innerHTML = '<p>ğŸ“ é»æ“Šæˆ–æ‹–æ”¾å½±ç‰‡æª”æ¡ˆ</p>';
                } catch (error) {
                    document.getElementById('uploadArea').innerHTML = '<p style="color:red">âŒ è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢</p>';
                    console.error(error);
                    return;
                }
            }

            await analyzeVideo(file);
            document.getElementById('videoInfo').classList.remove('hidden');
            document.getElementById('optionsPanel').classList.remove('hidden');
            updatePrediction();
        }

        async function analyzeVideo(file) {
            const arrayBuffer = await file.arrayBuffer();
            await ffmpeg.writeFile('input.mp4', new Uint8Array(arrayBuffer));
            
            videoInfo = {
                name: file.name,
                size: (file.size / 1024 / 1024).toFixed(2),
            };
            
            document.getElementById('infoContent').innerHTML = `
                æª”æ¡ˆåç¨±: ${videoInfo.name}<br>
                æª”æ¡ˆå¤§å°: ${videoInfo.size} MB<br>
                æ ¼å¼: ${file.type}
            `;
        }

        function updatePrediction() {
            if (!videoFile || !videoInfo) return;
            
            const mode = document.querySelector('input[name="mode"]:checked').value;
            const duration = 5;
            const audioBitrate = parseInt(document.getElementById('audioBitrate').value) / 1000;
            
            let predictedSize = 0;
            
            if (mode === 'size') {
                predictedSize = parseFloat(document.getElementById('targetSize').value);
            } else if (mode === 'bitrate') {
                const videoBitrate = parseFloat(document.getElementById('bitrate').value);
                predictedSize = ((videoBitrate + audioBitrate) * duration) / 8;
            } else {
                const crf = parseInt(document.getElementById('crf').value);
                const baseBitrate = 5 * Math.exp((23 - crf) * 0.1);
                predictedSize = ((baseBitrate + audioBitrate) * duration) / 8;
            }
            
            const reduction = ((1 - predictedSize / parseFloat(videoInfo.size)) * 100).toFixed(0);
            
            document.getElementById('prediction').innerHTML = `
                ğŸ“Š é è¨ˆè¼¸å‡ºå¤§å°: <strong>${predictedSize.toFixed(2)} MB</strong> 
                (å£“ç¸®ç‡ç´„ ${reduction > 0 ? reduction : 0}%)
            `;
            document.getElementById('prediction').classList.remove('hidden');
        }

        async function compressVideo() {
            const compressBtn = document.getElementById('compressBtn');
            const progress = document.getElementById('progress');
            
            compressBtn.disabled = true;
            compressBtn.textContent = 'â³ å£“ç¸®ä¸­...';
            progress.style.display = 'block';
            
            try {
                const mode = document.querySelector('input[name="mode"]:checked').value;
                const codec = document.getElementById('codec').value;
                const resolution = document.getElementById('resolution').value;
                const fps = document.getElementById('fps').value;
                const audioBitrate = document.getElementById('audioBitrate').value;
                
                let args = ['-i', 'input.mp4'];
                
                if (mode === 'crf') {
                    const crf = document.getElementById('crf').value;
                    args.push('-c:v', codec, '-crf', crf);
                } else if (mode === 'bitrate') {
                    const bitrate = document.getElementById('bitrate').value + 'M';
                    args.push('-c:v', codec, '-b:v', bitrate);
                } else {
                    const targetSize = parseFloat(document.getElementById('targetSize').value);
                    const duration = 5;
                    const audioBitrateKbps = parseInt(audioBitrate);
                    const targetBitrate = ((targetSize * 8 * 1024) / duration) - audioBitrateKbps;
                    args.push('-c:v', codec, '-b:v', Math.max(500, targetBitrate) + 'k');
                }
                
                if (resolution !== 'original') {
                    args.push('-vf', `scale=${resolution}`);
                }
                
                if (fps !== 'original') {
                    args.push('-r', fps);
                }
                
                args.push('-c:a', 'aac', '-b:a', audioBitrate);
                args.push('output.mp4');
                
                await ffmpeg.exec(args);
                
                const data = await ffmpeg.readFile('output.mp4');
                compressedBlob = new Blob([data.buffer], { type: 'video/mp4' });
                
                const outputSize = (compressedBlob.size / 1024 / 1024).toFixed(2);
                const reduction = ((1 - compressedBlob.size / videoFile.size) * 100).toFixed(0);
                
                document.getElementById('prediction').innerHTML = `
                    âœ… å£“ç¸®å®Œæˆï¼<br>
                    åŸå§‹å¤§å°: ${videoInfo.size} MB â†’ å£“ç¸®å¾Œ: <strong>${outputSize} MB</strong><br>
                    æ¸›å°‘äº† ${reduction}% çš„æª”æ¡ˆå¤§å°
                `;
                
                document.getElementById('downloadBtn').classList.remove('hidden');
                compressBtn.textContent = 'âœ… å£“ç¸®å®Œæˆ';
                
            } catch (error) {
                alert('å£“ç¸®å¤±æ•—: ' + error.message);
                compressBtn.disabled = false;
                compressBtn.textContent = 'ğŸš€ é–‹å§‹å£“ç¸®';
            } finally {
                progress.style.display = 'none';
            }
        }

        function downloadVideo() {
            if (!compressedBlob) return;
            
            const url = URL.createObjectURL(compressedBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = videoFile.name.replace(/\.[^/.]+$/, '') + '_compressed.mp4';
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
